---
output: 
    html_document:
        css: style.css
---

```{r setup, include=FALSE}
airsci_loc <- Sys.getenv("R_AIRSCI")
suppressMessages(devtools::load_all(airsci_loc))
load_all()
library(pander)
library(tidyverse)
library(lubridate)
panderOptions('knitr.auto.asis', FALSE)
panderOptions('keep.line.breaks', TRUE)
panderOptions('table.alignment.rownames', 'left')
```

```{r load_data, include=FALSE}
flux_df <- load_site_data(area, start_date, end_date)
flux_df[flux_df$sand_flux<=0, ]$sand_flux <- 0
area_polys <- pull_onlake_polygons() %>% 
    rename(id2=dca_name) %>%
    mutate(id1=id2, id3=id2)
area_labels <- pull_onlake_labels() %>% 
    mutate(id2=label, id1=label, id3=label)
if (area=='twb2'){
    area_polys <- group_twb2_areas(area_polys)
    area_labels <- group_twb2_areas(area_labels)
}
csc_locs <- load_sites(area, area_polys) 
csc_locs <- csc_locs %>% arrange(csc) %>% filter(active) %>%
    left_join(distinct(select(area_polys, objectid, id1, id2, id3)), by="objectid")
csc_collections <- load_collections(area)
report_index <- unique(csc_locs$id3)[!is.na(unique(csc_locs$id3))]
```

```{r sandmass, include=FALSE}
source("~/code/owensReports/scripts/sandmass.R")
```

```{r sandflux, include=FALSE}
source("~/code/owensReports/scripts/sandflux.R")
```

```{r pairs, include=FALSE}
if (area=='twb2') source("~/code/owensReports/scripts/twb2_pairs.R")
```

```{r surface, include=FALSE}
if (area=='twb2') source("~/code/owensReports/scripts/twb2_surface.R")
```

```{r lidar, include=FALSE}
if (area=='twb2') source("~/code/owensReports/scripts/twb2_lidar.R")

```{r changes, include=FALSE}
# One-off adjustments specific to report
# CHECK EACH MONTH AND CHANGE IF NECESSARY
change_file <- paste0(area, month(start_date), year(start_date), ".R")
gdrive_change <- system(paste0(getwd(), "/gdrive list ", 
                  "-q \"'0B8qHESXOhs-DX29FTnVIa0xielU' in parents\""), intern=T)  
change_fl <- tempfile()
write.table(gdrive_change, file=change_fl, quote=F, row.names=F, col.names=F)
change_list <- read.table(change_fl, header=F, skip=1)
if (change_file %in% change_list[ , 2]){
    ind <- which(change_list[ , 2]==change_file)
    system(paste0(getwd(), "/gdrive download --path ", tempdir(), " ", 
                  change_list[ , 1][ind]))
    source(paste0(tempdir(), "/", change_file))
}
```

```{r plot_image, include=FALSE}
img_files <- vector(mode="character", length=length(report_index))
names(img_files) <- report_index
pair_img_files <- img_files
surface_img_files <- img_files
for (i in report_index){
    img_files[[i]] <- paste0(tempfile(), ".png")
    png(filename=img_files[[i]], width=8, height=4, units="in", res=300)
    gridExtra::grid.arrange(flux_grobs[[i]], ncol=2)
    dev.off()
    if (area=='twb2' & i!='East'){
        # twb2 report also shows TEOM pair maps
        pair_img_files[[i]] <- paste0(tempfile(), ".png")
        png(filename=pair_img_files[[i]], width=8, height=4, units="in", res=300)
        gridExtra::grid.arrange(pair_grobs[[i]], ncol=2)
        dev.off()
    }
    if (area=='twb2'){
        # twb2 report also shows surface data trend plots
        surface_img_files[[i]] <- paste0(tempfile(), ".png")
        png(filename=surface_img_files[[i]], width=8, height=8, units="in", res=300)
        gridExtra::grid.arrange(surface_grobs[[i]]$rh_plot, 
                                surface_grobs[[i]]$rsrh_plot, 
                                surface_grobs[[i]]$clods_plot, ncol=2)
        dev.off()
    }
}
```

```{r output, echo=F, results='asis', warning=FALSE}
for (i in report_index){
    # build page titles
    if (area=='twb2'){
        ttle <- paste0(" \n# ", i, " TwB2 \n")
    } else{ 
        ttle <- paste0(" \n# ", i, " \n")
    }
    report_header(start_date, end_date, report_date, area)
    cat(ttle)
    # site maps on top of page
    cat(" \n## Monitoring Site Results \n")
    cat(paste0("![](", img_files[[i]], ")"))
        # tables for all other reports
        cat(" \n\n## Daily Sand Flux \n")
        if (area %in% c("channel", "t1a1")){
            area_index <- c('channel'='Channel Areas are', 't1a1'='T1A-1 is')
            cat(paste0("\n\nNote that the ", area_index[area], " not subject ", 
                       "to a specific sand flux threshold. However, this report ",
                       "includes dates when sand flux was observed in excess of ",
                       "1.0 g/cm<sup>2</sup>/day; the most conservative sand flux ",
                       "threshold applied to the approved Best Approved ",
                       "Control Measures.\n"))
        }
        if (area=='twb2'){
            cat(paste0(" \nThe sand flux threshold for maintenance is 0.5 ",
                       "g/cm<sup>2</sup>/day. The reflood threshold is 1.0 ",
                       "g/cm<sup>2</sup>/day (Rule 433, paragraph h.i.).\n"))
        }
        if (area %in% c("brine", "dwm")){
            cat(paste0(" \nErosion threshold to trigger BACM Shallow Flooding ", 
                       "is sand flux of 5.0 grams per square centimeter per day ", 
                       "(Rule 433, paragraph h.*i*.) \n"))
        } 
        if (area=='twb2'){
            # twb2 is broken up into regions
            tbl_flux <- daily_flux %>% filter(id3==i, sand.flux>=0.5) %>% 
                select(id2, csc, date, sand.flux) %>% arrange(desc(sand.flux))
            colnames(tbl_flux) <- c("DCA", "CSC Site", "Date", 
                                    "Sand Flux\\\n(g/cm<sup>2</sup>/day)") 
            tbl_mass <- csc_mass %>% filter(id3==i) %>% 
                select(csc, sand.mass, comment) %>% arrange(csc)
            if (nrow(tbl_mass)>0){
                for (row_num in 1:nrow(tbl_mass)){
                    if(!is.na(tbl_mass$comment[row_num])){
                        tbl_mass$sand.mass[row_num] <- tbl_mass$comment[row_num]
                    }
                }
            }
            tbl_mass <- select(tbl_mass, -comment)
            colnames(tbl_mass) <- c("CSC Site", "Sand Mass (g)") 
            row.names(tbl_mass) <- NULL
        } else{
            # all other reports are broken up by DCA
            tbl_flux <- daily_flux %>% filter(id2==i, sand.flux>=1) %>% 
                select(csc, date, sand.flux) %>% arrange(date, sand.flux) 
            tbl_flux <- tbl_flux[!duplicated(tbl_flux), ]
            colnames(tbl_flux) <- c("CSC Site", "Date", 
                                    "Sand Flux\\\n(g/cm<sup>2</sup>/day)") 
            row.names(tbl_flux) <- NULL
            tbl_mass <- csc_mass %>% filter(id2==i) %>% 
                select(csc, sand.mass, comment) %>% arrange(csc)
            if (nrow(tbl_mass)>0){
                for (row_num in 1:nrow(tbl_mass)){
                    if(!is.na(tbl_mass$comment[row_num])){
                        tbl_mass$sand.mass[row_num] <- tbl_mass$comment[row_num]
                    }
                }
            }
            tbl_mass <- select(tbl_mass, -comment)
            colnames(tbl_mass) <- c("CSC Site", "Sand Mass (g)") 
            row.names(tbl_mass) <- NULL
        }
        split_size <- 1
        if (nrow(tbl_flux)==0){
            if (area=='tbw2'){
                cat(" \nNo days with measured sand flux >= 0.5 g/cm<sup>2</sup>/day. \n")
            } else{
                cat(" \nNo days with measured sand flux >= 1.0 g/cm<sup>2</sup>/day. \n")
            }
        } else{
            if (area=='tbw2'){
                cat(" \nDays with recorded sand flux >= 0.5 g/cm<sup>2</sup>/day: \n")
            } else{
                cat(" \nDays with recorded sand flux >= 1.0 g/cm<sup>2</sup>/day: \n")
            }
            if (nrow(tbl_flux)<16){
                tbl_flux_list <- vector(mode='list', length=1)
                tbl_flux_list[[1]] <- tbl_flux
                pandoc.table(as.data.frame(tbl_flux_list[[1]]), split.table=Inf)
            } else{
                # if flux table is too large, break into sections
                split_size <- 2 + (nrow(tbl_flux[-(1:17), ]) %/% 35)
                split_factors <- rep(1, 17) 
                for (k in 2:split_size){
                    split_factors <- c(split_factors, rep(k, 35))
                }
                tbl_flux_list <- split(tbl_flux, split_factors)
                for (j in 1:split_size){
                    if (j > 1){
                        report_header(start_date, end_date, report_date, area)
                        cat(" \n\n## Daily Sand Flux - Continued\n")
                    }
                    row.names(tbl_flux_list[[j]]) <- 1:nrow(tbl_flux_list[[j]])
                    pandoc.table(as.data.frame(tbl_flux_list[[j]]), 
                                 split.table=Inf)
                    if (j < split_size){
                        cat("<p style=\"page-break-after:always;\"></p> \n")
                    }
                }
            }
        }
    # check for comment file and see how long
    gdrive_comments <- system(paste0(getwd(), "/gdrive list ", 
                      "-q \"trashed = false and ", 
                      "'0B8qHESXOhs-DXzJfRXdmUXoyWGs' in parents\" ", 
                      "-m 10000"), intern=T)  
    cmnt_fl <- tempfile()
    write.table(gdrive_comments, file=cmnt_fl, quote=F, row.names=F, col.names=F)
    comment_list <- read.table(file=cmnt_fl, sep="", header=F, na.strings="", 
                               skip=1)
    comment_file <- 
        gsub(" ", "", paste0(area, month(start_date), year(start_date), i, ".txt"))
    if (comment_file %in% comment_list[ , 2]){
        system(paste0(getwd(), "/gdrive download --path ", tempdir(), " ", 
                      comment_list[ , 1][which(comment_list[ , 2]==comment_file)]))
        comment_length <- 1 + length(readLines(paste0(tempdir(), "/", comment_file)))
    } else{
        comment_length <- 1
    }

    row_limit <- if_else(split_size==1, 15, 34)
    flux_length <- ifelse(exists("tbl_flux_list"), 
                          nrow(tbl_flux_list[[split_size]]), 0)
    if (flux_length + nrow(tbl_mass) + comment_length < row_limit){
        cat(" \n\n## Monthly Sand Mass \n")
        pandoc.table(as.data.frame(tbl_mass))
    } else if (flux_length + nrow(tbl_mass) < row_limit){
        cat(" \n\n## Monthly Sand Mass \n")
        pandoc.table(as.data.frame(tbl_mass))
        cat("<p style=\"page-break-after:always;\"></p> \n")
        report_header(start_date, end_date, report_date, area)
        cat(ttle)
    } else{
        cat("<p style=\"page-break-after:always;\"></p> \n")
        report_header(start_date, end_date, report_date, area)
        cat(ttle)
        cat(" \n\n## Monthly Sand Mass \n")
        pandoc.table(as.data.frame(tbl_mass))
    }
    if (comment_file %in% comment_list[ , 2]){
        cat(" \n\n## Comments \n")
        for (n in 1:length(readLines(paste0(tempdir(), "/", comment_file)))){
            cat(" \n", readLines(paste0(tempdir(), "/", comment_file))[n], 
                " \n", sep="")
        }
    }
    cat("<p style=\"page-break-after:always;\"></p> \n")

    if (area=='twb2' & i!="East"){
        report_header(start_date, end_date, report_date, area)
        cat(ttle)
        cat(" \n## Paired TEOM PM10 Results\n")
        cat(paste0("![](", pair_img_files[[i]], ")"))
        cat(" \n\n\n\n")
        tbl_pair <- daily_summary %>% filter(id3==i, pm10.delta>0) %>% 
            arrange(desc(pm10.delta)) %>% select(-id3, -status)
        colnames(tbl_pair) <- c("Date", 
                                "Upwind Cross-Tillage\\\nAvg. PM10 (micrograms/m<sup>3</sup>)", 
                                "Downwind Cross-Tillage\\\nAvg. PM10 (micrograms/m<sup>3</sup>)", 
                                "Increase in Avg.\\\n PM10 (micrograms/m<sup>3</sup>)", 
                                "Windspeed at Max Hourly\\\nPM10 Increase (m/s)")
        if (nrow(tbl_pair)>20){
            cat("<p style=\"page-break-after:always;\"></p> \n")
            report_header(start_date, end_date, report_date, area)
            cat(ttle)
            cat(" \n## Paired TEOM PM10 Results\n")
        }
        pandoc.table(as.data.frame(tbl_pair), split.table=Inf)
        cat("<p style=\"page-break-after:always;\"></p> \n")
    }
    if (area=='twb2'& exists('surface_df')){
        report_header(start_date, end_date, report_date, area)
        cat(ttle)
        cat(" \n## Surface Survey Data\n")
        tbl_surface <- surface_df[[i]] %>% 
            filter(!(is.na(rs_avg) & is.na(rh_avg) & 
                     is.na(rs_rh) & is.na(clods))) %>%
            select(id2, site, rs_avg, rh_avg, rs_rh, clods)
        missing_surface <- surface_df[[i]] %>% 
            filter((is.na(rs_avg) & is.na(rh_avg) & 
                    is.na(rs_rh) & is.na(clods)))
        colnames(tbl_surface) <- c("DCA", "Site", "Row Spacing (cm)", 
                                   "Row Height (cm)", "RS/RH", 
                                   "Clod Coverage (%)")
        cat("<h6> \n")
        pandoc.table(as.data.frame(tbl_surface), split.table=Inf)
        cat("</h6> \n")
        cat(" \n\n## Comments \n")
        cat(" \n Sites not listed were not accessible due to flooding or were 
            undergoing tillage maintenance.\n")
        comment_file_surface <- 
            gsub(" ", "", paste0(area, month(start_date), year(start_date), i, 
                                 "_surface.txt"))
        if (comment_file_surface %in% comment_list[ , 2]){
            index <- which(comment_list[ , 2]==comment_file_surface)
            system(paste0(getwd(), "/gdrive download --path ", tempdir(), " ", 
                          comment_list[ , 1][which(comment_list[ , 2]==comment_file_surface)]))
            for (k in 1:length(readLines(paste0(tempdir(), "/", comment_file_surface)))){
                cat(" \n", readLines(paste0(tempdir(), "/", comment_file_surface))[k], 
                    " \n", sep="")
            }
        }
        cat("<p style=\"page-break-after:always;\"></p> \n")
        report_header(start_date, end_date, report_date, area)
        cat(ttle)
        cat(" \n## Surface Survey Data Trend Plots\n")
        cat(paste0("![](", surface_img_files[[i]], ")"))
        cat("<p style=\"page-break-after:always;\"></p> \n")
    }
    if (area=='twb2'){
        report_header(start_date, end_date, report_date, area)
        cat(ttle)
        cat(" \n## LiDAR Roughness Maps\n")
        cat(" \n Maps developed from most recently processed data.\n")
        for (n in 1:length(lidar_files[[i]])){
            cat(paste0("<p>![](", lidar_files[[i]][n], ")</p>"))
            if (n %% 2 == 0){
                cat("<p style=\"page-break-after:always;\"></p> \n")
                report_header(start_date, end_date, report_date, area)
                cat(ttle)
                cat(" \n## LiDAR Roughness Maps (Continued)\n")
                cat(" \n Maps developed from most recently processed data.\n")
            }
        }
        cat("<p style=\"page-break-after:always;\"></p> \n")
    }
}
```

