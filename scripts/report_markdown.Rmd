---
output: 
    html_document:
        css: style.css
---

```{r setup, include=FALSE}
load_all("~/code/aiRsci")
load_all("~/code/owensMaps")
load_all("~/code/Roses")
load("~/code/owensMaps/data/map_data.RData")
load_all()
library(pander)
library(tidyverse)
panderOptions('knitr.auto.asis', FALSE)
panderOptions('keep.line.breaks', TRUE)
panderOptions('table.alignment.rownames', 'left')
```

```{r load_data, include=FALSE}
flux_df <- load_sandflux(area, start_date, end_date)
flux_df$bad_coll <- sapply(flux_df$sand_flux, function(x) 
                           if_else(x<0, TRUE, FALSE))
flux_df[flux_df$sand_flux<=0, ]$sand_flux <- 0
if (area=='sfwcrft'){
    area_polys <- sfwcrft$polygons %>% rename(id1=treatment, id2=dca) %>%
        mutate(id3=id2)
    area_data <- sfwcrft$data %>% rename(id1=treatment, id2=dca) %>%
        mutate(id3=id2)
    area_labels <- sfwcrft$labels %>% rename(id1=treatment, id2=dca) %>%
        mutate(id3=id2)
} else if (area=='twb2'){
    twb2 <- group_twb2_areas()
    area_polys <- twb2$polygons %>% rename(id2=dca, id3=group) %>%
        mutate(id1=id2)
    area_data <- twb2$data %>% rename(id2=dca, id3=group) %>%
        mutate(id1=id2)
    area_labels <- twb2$labels %>% rename(id2=dca, id3=group) %>%
        mutate(id1=id2)
} else{
    area_polys <- owens$polygons %>% rename(id2=dca) %>%
        mutate(id1=id2, id3=id2)
    area_data <- owens$data %>% rename(id2=dca) %>%
        mutate(id1=id2, id3=id2)
}
full_locs <- load_sites(area)
csc_locs <- select(full_locs, csc, x, y)
csc_locs$objectid <- apply(cbind(csc_locs$x, csc_locs$y), 1, 
                           owensMaps::point_in_dca, poly_df=area_polys)
csc_locs$objectid <- sapply(csc_locs$objectid, function(x) ifelse(is.null(x), 
                                                                  NA, x))
csc_locs <- csc_locs %>% 
    left_join(select(area_data, objectid, id1, id2, id3), by="objectid")
```

```{r sandmass, include=FALSE}
source("~/code/owensReports/scripts/sandmass.R")
```

```{r sandflux, include=FALSE}
source("~/code/owensReports/scripts/sandflux.R")
```

```{r pairs, include=FALSE}
if (area=='twb2') source("~/code/owensReports/scripts/twb2_pairs.R")
```

```{r surface, include=FALSE}
if (area=='twb2') source("~/code/owensReports/scripts/twb2_surface.R")
```

```{r wetness, include=FALSE}
if (area=='sfwcrft') source("~/code/owensReports/scripts/sfwcrft_wetness.R")
```

```{r plot_image, include=FALSE}
index <- unique(max_daily$id3)[!is.na(unique(max_daily$id3))]
img_files <- vector(mode="character", length=length(index))
names(img_files) <- index
pair_img_files <- img_files
for (i in index){
    img_files[[i]] <- paste0(tempfile(), ".png")
    if (area=='sfwcrft'){
        # sfwcrft reports show both mass and flux site maps
        png(filename=img_files[[i]], width=8, height=4, units="in", res=300)
        gridExtra::grid.arrange(mass_grobs[[i]], flux_grobs[[i]], ncol=2)
        dev.off()
    } else{
        # all other reports show only flux map
        png(filename=img_files[[i]], width=8, height=4, units="in", res=300)
        gridExtra::grid.arrange(flux_grobs[[i]], ncol=2)
        dev.off()
    }
    if (area=='twb2' & i!='East'){
        # twb2 report also shows TEOM pair maps
        pair_img_files[[i]] <- paste0(tempfile(), ".png")
        png(filename=pair_img_files[[i]], width=8, height=4, units="in", res=300)
        gridExtra::grid.arrange(pair_grobs[[i]], ncol=2)
        dev.off()
    }
}
```

```{r output, echo=F, results='asis', warning=FALSE}
for (i in index){
    # build page titles
    if (area=='twb2'){
        ttle <- paste0(" \n# ", i, " TwB2 \n")
    } else{ 
        ch_areas <- c("C1"="Channel Area North", "C2"="Channel Area South")
        ttle <- ifelse(i %in% names(ch_areas), 
                       paste0(" \n# ", ch_areas[i], " \n"), 
                       paste0(" \n# ", i, " \n"))
    }
    report_header(start_date, end_date, report_date, area)
    cat(ttle)
    # site maps on top of page
    cat(" \n## Monitoring Site Results \n")
    if (area=='sfwcrft') cat("(Area label indicates wetness cover target.) \n")
    cat(paste0("![](", img_files[[i]], ")"))
    if (area=='sfwcrft'){
        # tables for sfwcrft reports
        cat(" \n\n## Monthly Sand Reduction Control Efficiency \n")
        cat(paste0(" \n Monthly sand reduction control efficiency is only ", 
                   "calculated if area average sand mass in the control area ",
                   "is more than 10 grams for the month. \n"))
        tbl_mass <- mass_ce %>% filter(id2==i) 
        colnames(tbl_mass) <- c("DCA", "Target\nWetness", 
                                "Area Average\nSand Mass\\\n(g/month)", 
                                "Control Efficiency")
        pandoc.table(tbl_mass)
        cat(" \n\n## Daily Sand Flux Reduction Control Efficiency \n")
        tbl_flux <- flux_ce %>% filter(id2==i) 
        if (nrow(tbl_flux)==0){
            cat(" \n\nNo days with average daily flux in control area 
                > 1 g/cm^2/day. \n")
        } else{
            cat(paste0(" \n Daily sand flux reduction control efficiency is ",
                       "only reported for days when the area average sand flux ",
                       "in the control area is more than 1 g/cm^2/day. \n"))
            colnames(tbl_flux) <- c("DCA", "Date", 
                                    "0% Target\\\nAvg. Daily Flux\\\n(g/cm^2/day)", 
                                    "55% Target\\\nAvg. Daily Flux\\\n(g/cm^2/day)", 
                                    "65% Target\\\nAvg. Daily Flux\\\n(g/cm^2/day)", 
                                    "CE\\\n(55% Target)",
                                    "CE\\\n(65% Target)") 
            pandoc.table(tbl_flux, split.table=Inf)
        }
    } else{
        # tables for all other reports
        cat(" \n\n## Daily Sand Flux \n")
        if (area %in% c("channel", "t1a1")){
            area_index <- c('channel'='Channel Areas are', 't1a1'='T1A-1 is')
            cat(paste0("\n\nNote that the ", area_index[area], " not subject ", 
                       "to a specific sand flux threshold. However, this report ",
                       "includes dates when sand flux was observed in excess of ",
                       "1.0 g/cm<sup>2</sup>/day; the most conservative sand flux ",
                       "threshold applied to the approved Best Approved ",
                       "Control Measures.\n"))
        }
        if (area=='twb2'){
            cat(paste0(" \nThe sand flux threshold for maintenance is 0.5 ",
                       "g/cm<sup>2</sup>/day. The reflood threshold is 1.0 ",
                       "g/cm<sup>2</sup>/day (Rule 433, paragraph h.i.).\n"))
        }
        if (area %in% c("brine", "dwm")){
            cat(paste0(" \nErosion threshold to trigger BACM Shallow Flooding ", 
                       "is sand flux of 5.0 grams per square centimeter per day ", 
                       "(Rule 433, paragraph h.*i*.) \n"))
        } 
        if (area=='twb2'){
            # twb2 is broken up into regions
            tbl_flux <- full_daily %>% filter(id3==i, sand.flux>0.5) %>% 
                select(id2, csc, date, sand.flux) %>% arrange(desc(sand.flux))
            colnames(tbl_flux) <- c("DCA", "CSC Site", "Date", 
                                    "Sand Flux\\\n(g/cm<sup>2</sup>/day)") 
            tbl_mass <- csc_mass %>% filter(id3==i) %>% 
                select(csc, sand.mass) %>% arrange(csc)
            colnames(tbl_mass) <- c("CSC Site", "Sand Mass (g)") 
        } else{
            # all other reports are broken up by DCA
            tbl_flux <- full_daily %>% filter(id2==i, sand.flux>1) %>% 
                arrange(date, sand.flux) %>% select(csc, date, sand.flux)
            tbl_flux <- tbl_flux[!duplicated(tbl_flux), ]
            colnames(tbl_flux) <- c("CSC Site", "Date", 
                                    "Sand Flux\\\n(g/cm<sup>2</sup>/day)") 
            tbl_mass <- csc_mass %>% filter(id2==i) %>% select(csc, sand.mass)
            colnames(tbl_mass) <- c("CSC Site", "Sand Mass (g)") 
        }
        split_size <- 1
        if (nrow(tbl_flux)==0){
            cat(" \nNo days with measured sand flux > 1.0 g/cm<sup>2</sup>/day. \n")
        } else{
            if (area=='tbw2'){
                cat(" \nDays with recorded sand flux > 0.5 g/cm<sup>2</sup>/day: \n")
            } else{
                cat(" \nDays with recorded sand flux > 1.0 g/cm<sup>2</sup>/day: \n")
            }
            if (nrow(tbl_flux)<16){
                tbl_flux_list <- vector(mode='list', length=1)
                tbl_flux_list[[1]] <- tbl_flux
                pandoc.table(tbl_flux_list[[1]], split.table=Inf)
            } else{
                # if flux table is too large, break into sections
                split_size <- 2 + (nrow(tbl_flux[-(1:17), ]) %/% 35)
                split_factors <- rep(1, 17) 
                for (k in 2:split_size){
                    split_factors <- c(split_factors, rep(k, 35))
                }
                tbl_flux_list <- split(tbl_flux, split_factors)
                for (j in 1:split_size){
                    if (j > 1){
                        report_header(start_date, end_date, report_date, area)
                        cat(" \n\n## Daily Sand Flux - Continued\n")
                    }
                    row.names(tbl_flux_list[[j]]) <- 1:nrow(tbl_flux_list[[j]])
                    pandoc.table(tbl_flux_list[[j]], split.table=Inf)
                    if (j < split_size){
                        cat("<p style=\"page-break-after:always;\"></p> \n")
                    }
                }
            }
        }
    }
    # check for comment file and see how long
    comment_file <- paste0("~/code/owensReports/data/comments/", area, month(start_date), 
                           year(start_date), i, ".txt")
    if (file.exists(comment_file)){ 
        comment_length <- 1 + length(readLines(comment_file))
    } else{
        comment_length <- 1
    }
    if (area!='sfwcrft'){
        # other reports formatting
        row_limit <- if_else(split_size==1, 17, 36)
        flux_length <- ifelse(exists("tbl_flux_list"), 
                              nrow(tbl_flux_list[[split_size]]), 0)
        if (flux_length + nrow(tbl_mass) + comment_length < row_limit){
            cat(" \n\n## Monthly Sand Mass \n")
            pandoc.table(tbl_mass)
        } else if (flux_length + nrow(tbl_mass) < row_limit){
            cat(" \n\n## Monthly Sand Mass \n")
            pandoc.table(tbl_mass)
            cat("<p style=\"page-break-after:always;\"></p> \n")
            report_header(start_date, end_date, report_date, area)
            cat(ttle)
        } else{
            cat("<p style=\"page-break-after:always;\"></p> \n")
            report_header(start_date, end_date, report_date, area)
            cat(ttle)
            cat(" \n\n## Monthly Sand Mass \n")
            pandoc.table(tbl_mass)
        }
    }
    cat(" \n\n## Comments \n")
    if (area=='sfwcrft'){
        if (is.na(swir_fl)){
            cat(" \n No SWIR image available for this report period. \n")
        }
    }
    if (file.exists(comment_file)){
        for (m in 1:length(readLines(comment_file))){
            cat(" \n ", readLines(comment_file)[m], " \n")
        }
    }
    cat("<p style=\"page-break-after:always;\"></p> \n")

    if (area=='sfwcrft'){
        if (!is.na(swir_fl)){
            report_header(start_date, end_date, report_date, area)
            cat(ttle)
            cat(" \n\n## SWIR Wet/Dry Image \n")
            cat(paste0("![](", dcas[[i]]$img_file, ")"))
            cat(" \n")
            cat(" \n## SWIR Estimated Wetness \n")
            tbl_wet <- wetness %>% filter(id2==i)
            colnames(tbl_wet) <- c("DCA", "Target Wetness", 
                                   "SWIR Estimated\nWetness")
            pandoc.table(tbl_wet)
            cat(" \n## Recorded Daily Precipitation in 30 Days Prior to SWIR Image \n")
            tbl_precip <- met_df %>% filter(id2==i, pre>0) %>%
                select(date, pre)
            tbl_precip$date <- format(tbl_precip$date, "%m-%d-%Y")
            colnames(tbl_precip) <- c("Date", "Precip (mm)")
            pandoc.table(tbl_precip)
            cat(" \n\n## Comments \n")
            cat(paste0(" \n SWIR image collected on ", 
                       month(swir_date, label=T, abbr=F), " ", day(swir_date), 
                       ", ", year(swir_date), ". \n"))
            cat(paste0(" \n Recorded daily precipitation collected from ",
                       "Meteorological Station ", 
                       filter(met_index, id2==i)$deployment, ". \n"))
            comment_file <- paste0("~/code/owensReports/data/comments/", area, 
                                   month(start_date), year(start_date), i, 
                                   "_wet.txt")
            if (file.exists(comment_file)){
                for (l in 1:length(readLines(comment_file))){
                    cat(" \n ", readLines(comment_file)[l], " \n")
                }
            }
            cat("<p style=\"page-break-after:always;\"></p> \n")
        }
    }
    if (area=='twb2' & i!="East"){
        report_header(start_date, end_date, report_date, area)
        cat(ttle)
        cat(" \n## Paired TEOM PM10 Results\n")
        cat(paste0("![](", pair_img_files[[i]], ")"))
        cat(" \n\n\n\n")
        tbl_pair <- daily_summary %>% filter(id3==i, pm10.delta>0) %>% 
            arrange(desc(pm10.delta)) %>% select(-id3, -status)
        colnames(tbl_pair) <- c("Date", 
                                "Upwind Cross-Tillage\\\nAvg. PM10 (micrograms/m<sup>3</sup>)", 
                                "Downwind Cross-Tillage\\\nAvg. PM10 (micrograms/m<sup>3</sup>)", 
                                "Increase in Avg.\\\n PM10 (micrograms/m<sup>3</sup>)", 
                                "Windspeed at Max Hourly\\\nPM10 Increase (m/s)")
        pandoc.table(tbl_pair, split.table=Inf)
        cat("<p style=\"page-break-after:always;\"></p> \n")
    }
    if (area=='twb2'& exists('surface_df')){
        report_header(start_date, end_date, report_date, area)
        cat(ttle)
        cat(" \n## Surface Survey Data\n")
        tbl_surface <- surface_df %>% filter(id3==i) %>% 
            select(id2, site, rs_avg, rh_avg, rs_rh, clods)
        colnames(tbl_surface) <- c("DCA", "Site", "Row Spacing (cm)", 
                                   "Row Height (cm)", "RS/RH", 
                                   "Clod Coverage (%)")
        cat("<h6> \n")
        pandoc.table(tbl_surface, split.table=Inf)
        cat("</h6> \n")
        cat(" \n\n## Comments \n")
        cat(" \n Sites not listed were not accessible due to flooding or were 
            undergoing tillage maintenance.\n")
        cat("<p style=\"page-break-after:always;\"></p> \n")
    }
}
```

