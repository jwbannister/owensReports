---
output: 
    html_document:
        css: style.css
---

```{r setup, include=FALSE}
load_all("~/code/aiRsci")
load_all()
library(pander)
library(tidyverse)
library(lubridate)
panderOptions('knitr.auto.asis', FALSE)
panderOptions('keep.line.breaks', TRUE)
panderOptions('table.alignment.rownames', 'left')
```

```{r load_data, include=FALSE}
flux_df <- load_site_data(area, start_date, end_date)
flux_df[flux_df$sand_flux<=0, ]$sand_flux <- 0
if (area=='sfwcrft'){
    area_polys <- pull_sfwcrft_polygons() %>% 
        rename(id1=treatment, id2=dca) %>% 
        mutate(id3=id2)
    area_labels <- pull_sfwcrft_labels() %>% 
        rename(id1=treatment, id2=dca) %>%
        mutate(id3=id2)
} else{
    area_polys <- pull_onlake_polygons() %>% 
        rename(id2=dca_name) %>%
        mutate(id1=id2, id3=id2)
    area_labels <- pull_onlake_labels() %>% 
        mutate(id2=label, id1=label, id3=label)
    if (area=='twb2'){
        area_polys <- group_twb2_areas(area_polys)
        area_labels <- group_twb2_areas(area_labels)
    }
}
csc_locs <- load_sites(area, area_polys)
csc_locs <- csc_locs %>% 
    left_join(distinct(select(area_polys, objectid, id1, id2, id3)), by="objectid")
csc_collections <- load_collections(area)
```

```{r sandmass, include=FALSE}
source("~/code/owensReports/scripts/sandmass.R")
```

```{r sandflux, include=FALSE}
source("~/code/owensReports/scripts/sandflux.R")
```

```{r pairs, include=FALSE}
if (area=='twb2') source("~/code/owensReports/scripts/twb2_pairs.R")
```

```{r surface, include=FALSE}
if (area=='twb2') source("~/code/owensReports/scripts/twb2_surface.R")
```

```{r wetness, include=FALSE}
if (area=='sfwcrft') source("~/code/owensReports/scripts/sfwcrft_wetness.R")
```

```{r changes, include=FALSE}
index <- unique(max_daily$id3)[!is.na(unique(max_daily$id3))]
# One-off adjustments specific to report
# CHECK EACH MONTH AND CHANGE IF NECESSARY
change_file <- paste0(area, month(start_date), year(start_date), ".R")
gdrive_change <- system(paste0(getwd(), "/gdrive list ", 
                  "-q \"'0B8qHESXOhs-DX29FTnVIa0xielU' in parents\""), intern=T)  
change_fl <- tempfile()
write.table(gdrive_change, file=change_fl, quote=F, row.names=F, col.names=F)
change_list <- read.table(change_fl, header=F, skip=1)
if (change_file %in% change_list[ , 2]){
    ind <- which(change_list[ , 2]==change_file)
    system(paste0(getwd(), "/gdrive download --path ", tempdir(), " ", 
                  change_list[ , 1][ind]))
    source(paste0(tempdir(), "/", change_file))
}
```

```{r plot_image, include=FALSE}
img_files <- vector(mode="character", length=length(index))
names(img_files) <- index
pair_img_files <- img_files
for (i in index){
    img_files[[i]] <- paste0(tempfile(), ".png")
    if (area=='sfwcrft'){
        # sfwcrft reports show both mass and flux site maps
        png(filename=img_files[[i]], width=8, height=4, units="in", res=300)
        gridExtra::grid.arrange(mass_grobs[[i]], flux_grobs[[i]], ncol=2)
        dev.off()
    } else{
        # all other reports show only flux map
        png(filename=img_files[[i]], width=8, height=4, units="in", res=300)
        gridExtra::grid.arrange(flux_grobs[[i]], ncol=2)
        dev.off()
    }
    if (area=='twb2' & i!='East'){
        # twb2 report also shows TEOM pair maps
        pair_img_files[[i]] <- paste0(tempfile(), ".png")
        png(filename=pair_img_files[[i]], width=8, height=4, units="in", res=300)
        gridExtra::grid.arrange(pair_grobs[[i]], ncol=2)
        dev.off()
    }
}
```

```{r output, echo=F, results='asis', warning=FALSE}
for (i in index){
    # build page titles
    if (area=='twb2'){
        ttle <- paste0(" \n# ", i, " TwB2 \n")
    } else{ 
        ttle <- paste0(" \n# ", i, " \n")
    }
    report_header(start_date, end_date, report_date, area)
    cat(ttle)
    # site maps on top of page
    cat(" \n## Monitoring Site Results \n")
    if (area=='sfwcrft') cat("(Area label indicates wetness cover target.) \n")
    cat(paste0("![](", img_files[[i]], ")"))
    if (area=='sfwcrft'){
        # tables for sfwcrft reports
        cat(" \n\n## Monthly Sand Reduction Control Efficiency \n")
        cat(paste0(" \n Monthly sand reduction control efficiency is only ", 
                   "calculated if area average sand mass in the control area ",
                   "is more than 10 grams for the month. \n"))
        tbl_mass <- mass_ce %>% filter(id2==i) 
        colnames(tbl_mass) <- c("DCA", "Target\nWetness", 
                                "Area Average\nSand Mass\\\n(g/month)", 
                                "Control Efficiency")
        pandoc.table(as.data.frame(tbl_mass))
        cat(" \n\n## Daily Sand Flux Reduction Control Efficiency \n")
        tbl_flux <- flux_ce %>% filter(id2==i) 
        if (nrow(tbl_flux)==0){
            cat(" \n\nNo days with average daily flux in control area 
                > 1 g/cm^2/day. \n")
        } else{
            cat(paste0(" \n Daily sand flux reduction control efficiency is ",
                       "only reported for days when the area average sand flux ",
                       "in the control area is more than 1 g/cm^2/day. \n"))
            colnames(tbl_flux) <- c("DCA", "Date", 
                                    "0% Target\\\nAvg. Daily Flux\\\n(g/cm^2/day)", 
                                    "55% Target\\\nAvg. Daily Flux\\\n(g/cm^2/day)", 
                                    "65% Target\\\nAvg. Daily Flux\\\n(g/cm^2/day)", 
                                    "CE\\\n(55% Target)",
                                    "CE\\\n(65% Target)") 
            pandoc.table(as.data.frame(tbl_flux), split.table=Inf)
        }
    } else{
        # tables for all other reports
        cat(" \n\n## Daily Sand Flux \n")
        if (area %in% c("channel", "t1a1")){
            area_index <- c('channel'='Channel Areas are', 't1a1'='T1A-1 is')
            cat(paste0("\n\nNote that the ", area_index[area], " not subject ", 
                       "to a specific sand flux threshold. However, this report ",
                       "includes dates when sand flux was observed in excess of ",
                       "1.0 g/cm<sup>2</sup>/day; the most conservative sand flux ",
                       "threshold applied to the approved Best Approved ",
                       "Control Measures.\n"))
        }
        if (area=='twb2'){
            cat(paste0(" \nThe sand flux threshold for maintenance is 0.5 ",
                       "g/cm<sup>2</sup>/day. The reflood threshold is 1.0 ",
                       "g/cm<sup>2</sup>/day (Rule 433, paragraph h.i.).\n"))
        }
        if (area %in% c("brine", "dwm")){
            cat(paste0(" \nErosion threshold to trigger BACM Shallow Flooding ", 
                       "is sand flux of 5.0 grams per square centimeter per day ", 
                       "(Rule 433, paragraph h.*i*.) \n"))
        } 
        if (area=='twb2'){
            # twb2 is broken up into regions
            tbl_flux <- full_daily %>% filter(id3==i, sand.flux>0.5) %>% 
                select(id2, csc, date, sand.flux) %>% arrange(desc(sand.flux))
            colnames(tbl_flux) <- c("DCA", "CSC Site", "Date", 
                                    "Sand Flux\\\n(g/cm<sup>2</sup>/day)") 
            tbl_mass <- csc_mass %>% filter(id3==i) %>% 
                select(csc, sand.mass) %>% arrange(csc)
            colnames(tbl_mass) <- c("CSC Site", "Sand Mass (g)") 
        } else{
            # all other reports are broken up by DCA
            tbl_flux <- full_daily %>% filter(id2==i, sand.flux>1) %>% 
                select(csc, date, sand.flux) %>% arrange(date, sand.flux) 
            tbl_flux <- tbl_flux[!duplicated(tbl_flux), ]
            colnames(tbl_flux) <- c("CSC Site", "Date", 
                                    "Sand Flux\\\n(g/cm<sup>2</sup>/day)") 
            row.names(tbl_flux) <- NULL
            tbl_mass <- csc_mass %>% filter(id2==i) %>% select(csc, sand.mass)
            colnames(tbl_mass) <- c("CSC Site", "Sand Mass (g)") 
            row.names(tbl_mass) <- NULL
        }
        split_size <- 1
        if (nrow(tbl_flux)==0){
            cat(" \nNo days with measured sand flux > 1.0 g/cm<sup>2</sup>/day. \n")
        } else{
            if (area=='tbw2'){
                cat(" \nDays with recorded sand flux > 0.5 g/cm<sup>2</sup>/day: \n")
            } else{
                cat(" \nDays with recorded sand flux > 1.0 g/cm<sup>2</sup>/day: \n")
            }
            if (nrow(tbl_flux)<16){
                tbl_flux_list <- vector(mode='list', length=1)
                tbl_flux_list[[1]] <- tbl_flux
                pandoc.table(as.data.frame(tbl_flux_list[[1]]), split.table=Inf)
            } else{
                # if flux table is too large, break into sections
                split_size <- 2 + (nrow(tbl_flux[-(1:17), ]) %/% 35)
                split_factors <- rep(1, 17) 
                for (k in 2:split_size){
                    split_factors <- c(split_factors, rep(k, 35))
                }
                tbl_flux_list <- split(tbl_flux, split_factors)
                for (j in 1:split_size){
                    if (j > 1){
                        report_header(start_date, end_date, report_date, area)
                        cat(" \n\n## Daily Sand Flux - Continued\n")
                    }
                    row.names(tbl_flux_list[[j]]) <- 1:nrow(tbl_flux_list[[j]])
                    pandoc.table(as.data.frame(tbl_flux_list[[j]]), 
                                 split.table=Inf)
                    if (j < split_size){
                        cat("<p style=\"page-break-after:always;\"></p> \n")
                    }
                }
            }
        }
    }
    # check for comment file and see how long
    gdrive_comments <- system(paste0(getwd(), "/gdrive list ", 
                      "-q \"'0B8qHESXOhs-DXzJfRXdmUXoyWGs' in parents\" ", 
                      "-m 10000"), intern=T)  
    cmnt_fl <- tempfile()
    write.table(gdrive_comments, file=cmnt_fl, quote=F, row.names=F, col.names=F)
    comment_list <- read.fwf(file=cmnt_fl, widths=c(29, 29), strip.white=T)
    comment_file <- paste0(area, month(start_date), year(start_date), i, ".txt")
    if (comment_file %in% comment_list[ , 2]){
        system(paste0(getwd(), "/gdrive download --path ", tempdir(), " ", 
                      comment_list[ , 1][which(comment_list[ , 2]==comment_file)]))
        comment_length <- 1 + length(readLines(paste0(tempdir(), "/", comment_file)))
    } else{
        comment_length <- 1
    }

    if (area!='sfwcrft'){
        # other reports formatting
        row_limit <- if_else(split_size==1, 15, 34)
        flux_length <- ifelse(exists("tbl_flux_list"), 
                              nrow(tbl_flux_list[[split_size]]), 0)
        if (flux_length + nrow(tbl_mass) + comment_length < row_limit){
            cat(" \n\n## Monthly Sand Mass \n")
            pandoc.table(as.data.frame(tbl_mass))
        } else if (flux_length + nrow(tbl_mass) < row_limit){
            cat(" \n\n## Monthly Sand Mass \n")
            pandoc.table(as.data.frame(tbl_mass))
            cat("<p style=\"page-break-after:always;\"></p> \n")
            report_header(start_date, end_date, report_date, area)
            cat(ttle)
        } else{
            cat("<p style=\"page-break-after:always;\"></p> \n")
            report_header(start_date, end_date, report_date, area)
            cat(ttle)
            cat(" \n\n## Monthly Sand Mass \n")
            pandoc.table(as.data.frame(tbl_mass))
        }
    }
    cat(" \n\n## Comments \n")
    if (area=='sfwcrft'){
        if (is.na(swir_fl)){
            cat(" \n No SWIR image available for this report period. \n")
        }
    }
    if (comment_file %in% comment_list[ , 2]){
        for (n in 1:length(readLines(paste0(tempdir(), "/", comment_file)))){
            cat(" \n", readLines(paste0(tempdir(), "/", comment_file))[n], 
                " \n", sep="")
        }
    }
    cat("<p style=\"page-break-after:always;\"></p> \n")

    if (area=='sfwcrft'){
        if (!is.na(swir_fl)){
            report_header(start_date, end_date, report_date, area)
            cat(ttle)
            cat(" \n\n## SWIR Wet/Dry Image \n")
            cat(paste0("![](", dcas[[i]]$img_file, ")"))
            cat(" \n")
            cat(" \n## SWIR Estimated Wetness \n")
            tbl_wet <- wetness %>% filter(id2==i)
            colnames(tbl_wet) <- c("DCA", "Target Wetness", 
                                   "SWIR Estimated\nWetness")
            pandoc.table(as.data.frame(tbl_wet))
            cat(" \n## Recorded Daily Precipitation in 30 Days Prior to SWIR Image \n")
            tbl_precip <- met_df %>% filter(id2==i, pre>0) %>%
                select(date, pre)
            tbl_precip$date <- format(tbl_precip$date, "%m-%d-%Y")
            colnames(tbl_precip) <- c("Date", "Precip (mm)")
            pandoc.table(as.data.frame(tbl_precip))
            cat(" \n\n## Comments \n")
            cat(paste0(" \n SWIR image collected on ", 
                       month(swir_date, label=T, abbr=F), " ", day(swir_date), 
                       ", ", year(swir_date), ". \n"))
            cat(paste0(" \n Recorded daily precipitation collected from ",
                       "Meteorological Station ", 
                       filter(met_index, id2==i)$deployment, ". \n"))
            comment_file_wet <- paste0(area, month(start_date), year(start_date), i, 
                                   "_wet.txt")
            if (comment_file_wet %in% comment_list[ , 2]){
                index <- which(comment_list[ , 2]==comment_file_wet)
                system(paste0(getwd(), "/gdrive download --path ", tempdir(), " ", 
                              comment_list[ , 1][which(comment_list[ , 2]==comment_file_wet)]))
                for (k in 1:length(readLines(paste0(tempdir(), "/", comment_file_wet)))){
                    cat(" \n", readLines(paste0(tempdir(), "/", comment_file_wet))[k], 
                        " \n", sep="")
                }
            }
            cat("<p style=\"page-break-after:always;\"></p> \n")
        }
    }
    if (area=='twb2' & i!="East"){
        report_header(start_date, end_date, report_date, area)
        cat(ttle)
        cat(" \n## Paired TEOM PM10 Results\n")
        cat(paste0("![](", pair_img_files[[i]], ")"))
        cat(" \n\n\n\n")
        # COMMENT FOR NORTH TWB2 JUNE REPORT ONLY - REMOVE AFTER
        if (start_date=='2017-06-01' & i=='North'){
            cat(" \n\n## Comments \n")
            cat(" \n Sites at T29-4 Dust Control Areas were previously removed 
                due to tillage maintenance activities.\n")
            cat(" \n No surface survey measurements were taken in June 2017 
                because the area is undergoing tillage maintenance.\n")
        }
        tbl_pair <- daily_summary %>% filter(id3==i, pm10.delta>0) %>% 
            arrange(desc(pm10.delta)) %>% select(-id3, -status)
        colnames(tbl_pair) <- c("Date", 
                                "Upwind Cross-Tillage\\\nAvg. PM10 (micrograms/m<sup>3</sup>)", 
                                "Downwind Cross-Tillage\\\nAvg. PM10 (micrograms/m<sup>3</sup>)", 
                                "Increase in Avg.\\\n PM10 (micrograms/m<sup>3</sup>)", 
                                "Windspeed at Max Hourly\\\nPM10 Increase (m/s)")
        if (nrow(tbl_pair)>20){
            cat("<p style=\"page-break-after:always;\"></p> \n")
            report_header(start_date, end_date, report_date, area)
            cat(ttle)
            cat(" \n## Paired TEOM PM10 Results\n")
        }
        pandoc.table(as.data.frame(tbl_pair), split.table=Inf)
        cat("<p style=\"page-break-after:always;\"></p> \n")
    }
    if (area=='twb2'& exists('surface_df')){
        report_header(start_date, end_date, report_date, area)
        cat(ttle)
        cat(" \n## Surface Survey Data\n")
        tbl_surface <- surface_df %>% filter(id3==i) %>% 
            select(id2, site, rs_avg, rh_avg, rs_rh, clods)
        colnames(tbl_surface) <- c("DCA", "Site", "Row Spacing (cm)", 
                                   "Row Height (cm)", "RS/RH", 
                                   "Clod Coverage (%)")
        cat("<h6> \n")
        pandoc.table(as.data.frame(tbl_surface), split.table=Inf)
        cat("</h6> \n")
        cat(" \n\n## Comments \n")
        cat(" \n Sites not listed were not accessible due to flooding or were 
            undergoing tillage maintenance.\n")
        cat("<p style=\"page-break-after:always;\"></p> \n")
    }
}
```

