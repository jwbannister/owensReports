---
output: 
    html_document:
        css: style.css
---

```{r setup, include=FALSE}
load_all()
library(pander)
library(tidyverse)
panderOptions('knitr.auto.asis', FALSE)
panderOptions('keep.line.breaks', TRUE)
panderOptions('table.alignment.rownames', 'left')
```
```{r load_data, include=FALSE}
flux_df <- load_sandflux(area, start_date, end_date)
sites_df <- load_sites(area, start_date, end_date)
```

```{r sandmass, include=FALSE}
source("~/code/owensReports/scripts/misc_sandmass.R")
```

```{r sandflux, include=FALSE}
source("~/code/owensReports/scripts/misc_sandflux.R")
```

```{r plot_image, include=FALSE}
img_files <- vector(mode="character", length=length(unique(csc_mass$dca)))
names(img_files) <- unique(csc_mass$dca)
for (i in unique(csc_mass$dca)){
    img_files[[i]] <- paste0(tempfile(), ".png")
    png(filename=img_files[[i]], width=6, height=3, units="in", res=300)
    gridExtra::grid.arrange(flux_grobs[[i]], ncol=2)
    dev.off()
}
```

```{r output, echo=F, results='asis'}
for (i in unique(csc_mass$dca)){
    titles <- c("C1"="C-North", "C2"="C-South")
    page_hdr <- ifelse(i %in% names(titles), titles[i], i)
    report_header(start_date, end_date, report_date, area)
    cat(paste0(" \n# ", page_hdr, " \n"))
    cat(" \n## Monitoring Site Results \n")
    cat(paste0("![](", img_files[[i]], ")"))
    cat(" \n\n## Daily Sand Flux \n")
    cat(" \n(5 highest days with recorded sand flux > 0.1 g/cm^2/day) \n")
    tbl_flux <- full_daily %>% filter(dca==i, sand.flux>0.1) %>% 
        select(dca, csc, date, sand.flux) %>% arrange(desc(sand.flux))
    if (nrow(tbl_flux)==0){
        cat(" \nNo days with measurable sand flux. \n")
    } else{
        colnames(tbl_flux) <- c("DCA", "CSC Site", "Date", 
                                "Sand Flux\\\n(g/cm^2/day)") 
        pandoc.table(tbl_flux[1:5, ], split.table=Inf)
    }
#    cat("<p style=\"page-break-after:always;\"></p> \n")
#    report_header(start_date, end_date, report_date, area)
#    cat(paste0(" \n# ", page_hdr, " \n"))
    cat(" \n\n## Monthly Sand Mass \n")
    tbl_mass <- csc_mass %>% filter(dca==i) %>% select(dca, csc, sand.mass)
    if (area=="dwm"){
        tbl_mass$sand.mass <- sapply(tbl_mass$sand.mass, 
                                     function(x) ifelse(x<0, "Flooded", x))
    }
    colnames(tbl_mass) <- c("DCA", "CSC Site", "Sand Mass (g)") 
    pandoc.table(tbl_mass)
    cat(" \n\n## Comments \n")
    if (area %in% c("brine", "dwm")){
        cat(" \nErosion threshold to trigger BACM Shallow Flooding is sand flux 
            of 5.0 grams per square centimeter per day (Rule 433, paragraph 
                                                        h.*i*.) \n")
    } 
    comment_file <- paste0("~/code/owensReports/data/", area, month(start_date), 
                           year(start_date), i, ".txt")
    if (file.exists(comment_file)){
        cat(" \n ", readLines(comment_file), " \n")
    }
    cat("<p style=\"page-break-after:always;\"></p> \n")
}
```

